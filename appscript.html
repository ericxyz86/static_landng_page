<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets AI Script â€” AI LABS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style-v3.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script>
    (function(){
      var t = localStorage.getItem('theme');
      if (t === 'light' || (!t && window.matchMedia('(prefers-color-scheme: light)').matches)) {
        document.documentElement.classList.remove('dark');
      }
    })();
    </script>
</head>
<body>

    <!-- Nav -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand">
                <img src="static/images/ailabs.png" alt="AI LABS">
            </a>
            <div class="nav-right">
                <a href="index.html" class="nav-link nav-link-text">Home</a>
                <a href="apps.html" class="nav-link nav-link-text">All Apps</a>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <svg id="icon-sun" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg id="icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
                <a href="https://github.com/ericxyz86" target="_blank" rel="noopener" class="nav-icon" aria-label="GitHub">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg>
                </a>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="page-wrap">
        <div class="page-header">
            <h1>Google Sheets AI Script</h1>
            <p>Last updated: February 12, 2024</p>
        </div>

        <div class="page-content">
            <section>
                <p>This App Script integrates AI capabilities directly into your Google Sheets. It primarily uses OpenAI's GPT-4o-mini model for text processing and automatically falls back to Google's Gemini-2.0-flash model if there are any issues with the OpenAI service. The script includes built-in caching, error handling, and rate limiting to ensure reliable performance.</p>
            </section>

            <section>
                <h2>Installation Instructions</h2>
                <ol>
                    <li>Open your Google Sheet</li>
                    <li>Click on Extensions &gt; Apps Script</li>
                    <li>Replace the content of Code.gs with the following code</li>
                    <li>Save the script and close the editor</li>
                    <li>Refresh your Google Sheet</li>
                    <li>You can now use the =GPT() function in your cells</li>
                </ol>
            </section>

            <section>
                <h2>App Script Code</h2>
                <pre><button class="copy-btn" onclick="copyCode()" aria-label="Copy code">
                    <svg id="copyIcon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    <svg id="checkIcon" style="display:none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </button><code id="appScriptCode" class="language-javascript">
// API Keys
const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY'; // Replace with your OpenAI API key
const GOOGLE_AI_API_KEY = 'YOUR_GOOGLE_AI_API_KEY'; // Replace with your Google AI Studio API key

// Constants
const CACHE_EXPIRATION = 21600; // Cache expiration in seconds (6 hours)
const MIN_REQUEST_GAP = 1000; // Minimum time between requests in milliseconds
let lastRequestTime = 0;

/**
 * Custom function to call AI models from a cell.
 * @param {string} prompt The input prompt for the AI model
 * @param {number} maxTokens The maximum number of tokens for the response. Optional, default is 450.
 * @return The generated text from the AI model.
 * @customfunction
 */
function GPT(prompt, maxTokens = 450) {
  if (!prompt || typeof prompt !== 'string') {
    return "Error: Invalid prompt. Please provide a non-empty string.";
  }
  if (maxTokens && (typeof maxTokens !== 'number' || maxTokens &lt;= 0)) {
    return "Error: Invalid maxTokens. Please provide a positive number.";
  }
  const hasValidOpenAI = isValidOpenAIKey();
  const hasValidGoogleAI = isValidGoogleAIKey();
  if (!hasValidOpenAI && !hasValidGoogleAI) {
    return "Error: No valid API keys found.";
  }
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var cell = sheet.getActiveCell();
  prompt = processCellReferences(prompt, sheet, cell);
  if (!prompt) { return "Error: Please provide a prompt."; }
  const openAIResponse = callOpenAI(prompt, maxTokens);
  if (openAIResponse.startsWith("Error:")) {
    return callGoogleAI(prompt, maxTokens);
  }
  return openAIResponse;
}

function isValidOpenAIKey() {
  return OPENAI_API_KEY && OPENAI_API_KEY !== 'YOUR_OPENAI_API_KEY'
    && OPENAI_API_KEY.startsWith('sk-') && OPENAI_API_KEY.length >= 40;
}

function isValidGoogleAIKey() {
  return GOOGLE_AI_API_KEY && GOOGLE_AI_API_KEY !== 'YOUR_GOOGLE_AI_API_KEY'
    && GOOGLE_AI_API_KEY.length >= 20;
}

function isValidResponse(response, service) {
  if (!response || typeof response !== 'object') return false;
  try {
    if (service === 'openai') {
      return response.choices && response.choices.length > 0
        && response.choices[0].message && response.choices[0].message.content;
    } else if (service === 'google') {
      return response.candidates && response.candidates.length > 0
        && response.candidates[0].content && response.candidates[0].content.parts
        && response.candidates[0].content.parts[0].text;
    }
  } catch (e) { return false; }
  return false;
}

function callOpenAI(prompt, maxTokens) {
  if (!isValidOpenAIKey()) return "Error: Invalid OpenAI API key";
  const apiUrl = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    'model': 'gpt-4o-mini',
    'messages': [
      {'role': 'system', 'content': 'You are a helpful data analyst.'},
      {'role': 'user', 'content': prompt}
    ],
    'max_tokens': maxTokens
  };
  const options = {
    'method': 'post', 'contentType': 'application/json',
    'headers': { 'Authorization': 'Bearer ' + OPENAI_API_KEY },
    'payload': JSON.stringify(payload), 'muteHttpExceptions': true
  };
  return fetchWithRetry(apiUrl, options, 'openai');
}

function callGoogleAI(prompt, maxTokens) {
  const cacheKey = createCacheKey(prompt, maxTokens);
  const cachedResponse = getCachedResponse(cacheKey);
  if (cachedResponse) return cachedResponse;
  const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
  const payload = {
    'contents': [{ 'parts': [{ 'text': prompt }] }],
    'generationConfig': { 'maxOutputTokens': maxTokens, 'temperature': 0.7 }
  };
  const options = {
    'method': 'post', 'contentType': 'application/json',
    'headers': { 'x-goog-api-key': GOOGLE_AI_API_KEY },
    'payload': JSON.stringify(payload), 'muteHttpExceptions': true
  };
  const response = fetchWithRetry(apiUrl, options, 'google');
  if (!response.startsWith("Error:")) cacheResponse(cacheKey, response);
  return response;
}

function fetchWithRetry(url, options, service) {
  const maxRetries = 5, baseDelay = 1000;
  let retryCount = 0;
  while (retryCount &lt; maxRetries) {
    try {
      const currentTime = new Date().getTime();
      if (currentTime - lastRequestTime &lt; MIN_REQUEST_GAP) {
        Utilities.sleep(MIN_REQUEST_GAP - (currentTime - lastRequestTime));
      }
      lastRequestTime = new Date().getTime();
      const response = UrlFetchApp.fetch(url, options);
      if (response.getResponseCode() === 200) {
        const json = JSON.parse(response.getContentText());
        if (!isValidResponse(json, service)) throw new Error('Invalid response');
        return service === 'openai'
          ? json.choices[0].message.content.trim()
          : json.candidates[0].content.parts[0].text.trim();
      }
      throw new Error(service + ' returned ' + response.getResponseCode());
    } catch (error) {
      retryCount++;
      if (retryCount === maxRetries) return 'Error: ' + error + '. Try again later.';
      Utilities.sleep(baseDelay * Math.pow(2, retryCount) * (0.5 + Math.random()));
    }
  }
}

function createCacheKey(prompt, maxTokens) {
  const hash = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, prompt + maxTokens);
  return hash.map(b => ('0' + (b & 0xFF).toString(16)).slice(-2)).join('').substring(0, 32);
}
function getCachedResponse(key) { return CacheService.getScriptCache().get(key); }
function cacheResponse(key, value) { CacheService.getScriptCache().put(key, value, CACHE_EXPIRATION); }

function processCellReferences(prompt, sheet, cell) {
  return prompt.replace(/\b[A-Z]+\d+\b/g, function(match) {
    try { return sheet.getRange(match).getValue().toString(); }
    catch (e) { return match; }
  });
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('AI Tools')
    .addItem('Replace AI Formulas with Values', 'replaceGPTFormulasWithValues')
    .addItem('Clear Cache', 'clearCache')
    .addToUi();
}

function clearCache() {
  CacheService.getScriptCache().removeAll();
  SpreadsheetApp.getUi().alert('Cache cleared!');
}

function replaceGPTFormulasWithValues() {
  var range = SpreadsheetApp.getActiveSheet().getSelection().getActiveRange();
  if (range.getNumColumns() !== 1) {
    SpreadsheetApp.getUi().alert('Select a single column.');
    return;
  }
  var values = range.getValues(), formulas = range.getFormulas();
  for (var i = 0; i &lt; values.length; i++) {
    if (formulas[i][0].toLowerCase().startsWith('=gpt(')) {
      values[i][0] = values[i][0].toString();
    }
  }
  range.setValues(values);
}</code></pre>
            </section>

            <section>
                <h2>Usage Examples</h2>
                <ul>
                    <li>=GPT("Summarize this text: " &amp; A1)</li>
                    <li>=GPT("Analyze the sentiment of: " &amp; B2)</li>
                    <li>=GPT("Categorize this product review: " &amp; C3)</li>
                </ul>
            </section>

            <section>
                <h2>Important Note</h2>
                <div class="note-box">
                    <p>Once you're done using the GPT() function on an entire column, copy that column and then right-click &gt; Paste special &gt; Values only. This prevents the script from re-running when you update the sheet.</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-inner">
            <p>&copy; 2026 Agile Intelligence AI LABS &middot; DDB Group Philippines</p>
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="apps.html">All Apps</a>
                <a href="https://github.com/ericxyz86" target="_blank" rel="noopener">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg>
                </a>
            </div>
        </div>
    </footer>

    <script src="static/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-javascript.min.js"></script>
    <script>
    function copyCode() {
        var code = document.getElementById('appScriptCode');
        var copyIcon = document.getElementById('copyIcon');
        var checkIcon = document.getElementById('checkIcon');
        navigator.clipboard.writeText(code.textContent).then(function() {
            copyIcon.style.display = 'none';
            checkIcon.style.display = 'block';
            setTimeout(function() {
                copyIcon.style.display = 'block';
                checkIcon.style.display = 'none';
            }, 2000);
        });
    }
    </script>
</body>
</html>
